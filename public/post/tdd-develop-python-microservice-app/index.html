<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="青年夏日IT">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://qnxr.xyz/img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="https://qnxr.xyz/img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="TDD开发容器化的Python微服务应用(一)" />
    <meta property="og:title" content="TDD开发容器化的Python微服务应用(一)" />
    <meta property="twitter:title" content="TDD开发容器化的Python微服务应用(一)" />
    

    
    <meta name="description" content="青年夏日，程序员, 开源爱好者，生活探险家 | 这里是 青年夏日 的博客，与你一起发现更大的世界。">
    <meta property="og:description" content="青年夏日，程序员, 开源爱好者，生活探险家 | 这里是 青年夏日 的博客，与你一起发现更大的世界。" />
    <meta property="twitter:description" content="青年夏日，程序员, 开源爱好者，生活探险家 | 这里是 青年夏日 的博客，与你一起发现更大的世界。" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="青年夏日, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>TDD开发容器化的Python微服务应用(一)-青年夏日IT</title>

    <link rel="canonical" href="/post/tdd-develop-python-microservice-app/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">青年夏日IT</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/life">life</a>
                        </li>
                        
                        <li>
                            <a href="/categories/note">note</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tips">tips</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/books/">BOOKS</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
		    <li>
                        <a href="/search">SEARCH <img src="/img/search.png" height="15" style="cursor: pointer;" alt="Search"></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-jeep.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/python" title="python">
                            python
                        </a>
                        
                        <a class="tag" href="/tags/flask" title="flask">
                            flask
                        </a>
                        
                        <a class="tag" href="/tags/tdd" title="TDD">
                            TDD
                        </a>
                        
                        <a class="tag" href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        <a class="tag" href="/tags/react" title="react">
                            react
                        </a>
                        
                        <a class="tag" href="/tags/kubernetes" title="kubernetes">
                            kubernetes
                        </a>
                        
                        <a class="tag" href="/tags/microservice" title="Microservice">
                            Microservice
                        </a>
                        
                    </div>
                    <h1>TDD开发容器化的Python微服务应用(一)</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                青年夏日IT
                         
                        on 
                        Thursday, December 28, 2017
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#目录">目录</a></li>
        <li><a href="#架构">架构</a></li>
        <li><a href="#第一部分">第一部分</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <p>在这个课程中，你将学习如何使用<code>Docker</code>快速创建开发环境、管理多个微服务，应用程序在本地运行后，您将学习怎样在生产环境部署应用。我们也会练习<code>TDD</code>(测试驱动开发)，在你的项目中测试先行，我们重点将放在服务端的单元测试、功能和集成测试以及端到端的测试上面，以确保整个系统按预期工作。</p>
<blockquote>
<p>有人问我为什么这么长的文章不分拆成几篇文章啊？这样阅读起来也方便啊，然而在我自己学习的过程中，这种整个一篇文章把一件事情从头到尾讲清楚的形式是最好的，能给读者提供一种<code>沉浸式</code>的学习体验，阅读完整个文章后有种<code>酣畅淋漓</code>的感觉，所以我选择这种一篇文章的形式。</p>
</blockquote>
<p>扫描下面的二维码(或微信搜索<code>iEverything</code>)添加我微信好友(注明python)，然后可以加入到我们的<code>python</code>讨论群里面共同学习

  <img src="/img/posts/wexin-qrcode.jpeg" alt="qrcode">

</p>
<h2 id="目录">目录</h2>
<ol>
<li><a href="#introduction">介绍</a></li>
<li><a href="#start">开始</a></li>
<li><a href="#docker">Docker 配置</a></li>
<li><a href="#database">数据库安装配置</a></li>
<li><a href="#test">测试</a></li>
<li><a href="#blueprint">Flask Buleprint</a></li>
<li><a href="#deploy">部署</a></li>
<li><a href="#jinja">Jinja模板</a></li>
</ol>
<h2 id="架构">架构</h2>
<ol>
<li>flask-microservices-main - Docker Compose 文件、Nginx、Admin 脚本</li>
<li>flask-microservices-users - 管理用户和认证的Flask 应用</li>
<li>flask-microservices-client - 客户端，React 应用</li>
<li>flask-microservices-swagger - Swagger API 文档</li>
</ol>
<h2 id="第一部分">第一部分</h2>
<h3 id="1-介绍a-idintroductiona">1. 介绍<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>项目中提到的代码都已经归档到<a href="https://github.com/cnych/flask-microservices-users/">github</a>上了，根据课程章节打上了<strong>tag</strong>。本课程是根据<a href="https://realpython.com/tdd/">RealPython的课程</a>进行改编的，希望看原版的就不要呆在这里骂我了，不送。</p>
<p>在第一部分，你将能够学习使用<code>Docker</code>、 <code>Flask</code>、<code>MySQL</code>来创建<code>RESTful</code> API服务。</p>
<blockquote>
<p>我们将采取一种实用的方法来进行测试驱动开发(TDD)</p>
</blockquote>
<p>课程开始之前，你应该要熟悉下面的这些主题：</p>
<ol>
<li>Docker - <a href="https://docs.docker.com/engine/getstarted/">Get started with Docker</a></li>
<li>Docker Compose - <a href="https://docs.docker.com/compose/gettingstarted/">Get started with Docker Compose</a></li>
<li>Flask - <a href="https://github.com/mjhea0/flaskr-tdd">Flaskr TDD</a></li>
</ol>
<p>该部分课程使用到的工具库：</p>
<ol>
<li>Python v3.6.4</li>
<li>Flask v0.12.2</li>
<li>Flask-Script v2.0.6</li>
<li>Flask-SQLAlchemy v2.3.2</li>
<li>Flask-Testing v0.7.1</li>
<li>PyMySQL v0.8.0</li>
<li>Gunicorn v19.7.1</li>
<li>Nginx v1.13.0</li>
<li>Docker v17.11.0-ce</li>
<li>Docker Compose v1.14.0</li>
</ol>
<p>本节课程结束，你能学到下面的知识点：</p>
<ol>
<li>用<code>Flask</code>开发一个<code>RESTful</code> API 服务</li>
<li>实践测试驱动开发(TDD)</li>
<li>在本地用<code>Docker</code>和<code>Docker Compose</code>配置和运行服务</li>
<li>将代码挂载到一个容器中去</li>
<li>在容器中运行单元测试和集成测试</li>
<li>不同容器的服务间的交互</li>
<li>在<code>Docker</code>容器中运行<code>Python</code>和<code>Flask</code>应用</li>
<li>安装<code>Flask</code>、<code>Nginx</code>和<code>Gunicorn</code></li>
</ol>
<h3 id="2-开始a-idstarta">2. 开始<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>本节课程我们将初始化项目框架、定义第一个服务。
创建一个新的项目、安装<code>Flask</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir flask-microservices-users <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#8be9fd;font-style:italic">cd</span> flask-microservices-users
$ mkdir project
$ pyenv virtualenv 3.6.4 tdd3
$ pyenv <span style="color:#8be9fd;font-style:italic">local</span> tdd3
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ pip install <span style="color:#8be9fd;font-style:italic">Flask</span><span style="color:#ff79c6">==</span>0.12.2
</code></pre></div><p>在project 目录下面添加<code>__init__.py</code>文件，配置第一个路由：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/__init__.py</span>
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, jsonify

<span style="color:#6272a4"># 初始化app</span>
app <span style="color:#ff79c6">=</span> Flask(__name__)


@app.route(<span style="color:#f1fa8c">&#39;/ping&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ping_pong</span>():
    <span style="color:#ff79c6">return</span> jsonify({
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;pong!&#39;</span>
    })
</code></pre></div><p>然后，添加<code>Flask-Script</code>，该依赖包可以用来在命令行管理<code>Flask</code> app:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ pip install Flask-Script<span style="color:#ff79c6">==</span>2.0.6
</code></pre></div><p>在项目根目录下面添加一个<code>manage.py</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># manage.py</span>
<span style="color:#ff79c6">from</span> flask_script <span style="color:#ff79c6">import</span> Manager
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> app

manager <span style="color:#ff79c6">=</span> Manager(app)

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    manager<span style="color:#ff79c6">.</span>run()
</code></pre></div><p>这里我们创建了一个新的<code>Manager</code>实例，来处理所有的从命令行输入的命令。运行程序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ python manage.py runserver
</code></pre></div><p>运行成功后，我们可以在浏览器中打开页面<code>http://localhost:5000/ping</code>，你能看到如下的json 信息输出到页面：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#ff79c6">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;pong!&#34;</span>,
  <span style="color:#ff79c6">&#34;status&#34;</span>: <span style="color:#f1fa8c">&#34;success&#34;</span>
}
</code></pre></div><p>然后我们关掉服务(Ctrl+C)，在<code>project</code>目录下面新增一个<code>config.py</code>的文件，内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> <span style="color:#6272a4">#project/config.py</span>
<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseConfig</span>:
    <span style="color:#f1fa8c">&#34;&#34;&#34;基础配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> False
    TESTING <span style="color:#ff79c6">=</span> False

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DevelopmentConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;开发环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> True

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestingConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;测试环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> True
    TESTING <span style="color:#ff79c6">=</span> True

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">ProductionConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;生产环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> False
</code></pre></div><p>然后更新<code>__init__.py</code>文件，在初始化的时候配置开发环境：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, jsonify

<span style="color:#6272a4"># 初始化app</span>
app <span style="color:#ff79c6">=</span> Flask(__name__)
<span style="color:#6272a4"># 环境配置</span>
app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(<span style="color:#f1fa8c">&#39;project.config.DevelopmentConfig&#39;</span>)

@app.route(<span style="color:#f1fa8c">&#39;/ping&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ping_pong</span>():
    <span style="color:#ff79c6">return</span> jsonify({
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;pong!&#39;</span>
    })
</code></pre></div><p>然后重新运行程序，我们能在终端中看到<code>debug</code>模式的提示信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ python manage.py runserver
    * Running on http://127.0.0.1:5000/ <span style="color:#ff79c6">(</span>Press CTRL+C to quit<span style="color:#ff79c6">)</span>
    * Restarting with stat
    * Debugger is active!
    * Debugger PIN: 770-657-842
</code></pre></div><p>现在当你的代码有任何改动的时候，应用都会自动加载，不需要手动重启了。为了保证我们的项目依赖能实时同步，这里我们将依赖包添加到一个<code>requirements.txt</code>的文件中，我们只需要利用<code>pip</code>的<strong>freeze</strong>命令就可以轻松拿到我们项目的依赖列表了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ pip freeze &gt; requirements.txt
</code></pre></div><p>然后看看<code>requirements.txt</code>的内容吧:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Flask==0.12.2
Flask-Script==2.0.6
</code></pre></div><p>最后，在项目根目录下面添加一个<code>.gitignore</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">__pycache__
env
</code></pre></div><p>初始化git 仓库，然后提交代码吧~</p>
<h3 id="3-docker-容器a-iddockera">3. Docker 容器<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>这节课让我们来容器化<code>Flask</code>应用吧&hellip;&hellip;
首先你需要确保你的环境中已经安装了<code>Docker</code>和<code>Docker Compose</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker -v
Docker version 17.05.0-ce, build 89658be
$ docker-compose -v
docker-compose version 1.14.0, build unknown
</code></pre></div><p>在项目的根目录下面创建一个<code>Dockerfile</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">FROM python:3.6.4

# 设置工作目录
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

# 添加依赖（利用Docker 的缓存）
ADD ./requirements.txt /usr/src/app/requirements.txt

# 安装依赖
RUN pip install -r requirements.txt

# 添加应用
ADD . /usr/src/app

# 运行服务
CMD python manage.py runserver -h 0.0.0.0
</code></pre></div><p>然后同样的在根目录下面创建一个<code>docker-compose.yml</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">version: &#39;2.1&#39;

services:
  users-service:
    container_name: users-service
    build: .
    volumes:
      - &#39;.:/usr/src/app&#39;
    ports:
      - 5001:5000  # 端口暴露（主机端口:容器端口）
</code></pre></div><p>执行上面的配置文件将根据<code>Dockerfile</code>创建一个叫<code>users-service</code>的容器。</p>
<blockquote>
<p><code>docker-compose.yml</code>文件中的目录是相对路径</p>
</blockquote>
<p><code>volumes</code>是用来将代码挂载进容器内部的，对于开发环境你最好这么做，不然你每次更新代码后都需要重新构建容器才会生效，显然这是非常影响效率的。</p>
<p>注意<a href="https://docs.docker.com/compose/compose-file/#compose-and-docker-compatibility-matrix">Docker compose 的文件版本</a>，我们这里用的<strong>2.1</strong>，这其实与你安装的<code>docker-compose</code>版本没有任何关系的，只与<code>Docker</code>版本有关系（通过上面的连接可以选择合适的文件版本），但是文件版本<strong>3.x</strong>和<strong>2.x</strong>还是有很多不同的地方，注意查看文档。</p>
<p>然后我们来构建镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose build
</code></pre></div><p>在第一次构建的时候会花费一点时间，不过别担心，由于<code>Docker</code>会缓存第一次的构建结果，后续的构建都会快得多，构建完成后，启动容器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose up -d
</code></pre></div><blockquote>
<p><code>-d</code>标记是用来让容器在后台执行的</p>
</blockquote>
<p>然后在浏览器中打开<a href="http://127.0.0.1:5001/ping">http://127.0.0.1:5001/ping</a>，确保你能看到和上面看到的JSON 文件信息。
接下来在<code>docker-compose.yml</code>文件中增加一个环境变量，用来加载开发环境的配置信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">version: &#39;2.1&#39;

services:
  users-service:
    container_name: users-service
    build: .
    volumes:
    - &#39;.:/usr/src/app&#39;
    ports:
    - 5001:5000 # 端口暴露（主机端口:容器端口）
    environment:
    - APP_SETTINGS=project.config.DevelopmentConfig
</code></pre></div><p>然后更新<code>proejct/__init__.py</code>文件，从环境变量获取应用的配置信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, jsonify

<span style="color:#6272a4"># 初始化app</span>
app <span style="color:#ff79c6">=</span> Flask(__name__)
<span style="color:#6272a4"># 环境配置</span>
app_settings <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;APP_SETTINGS&#39;</span>)
app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(app_settings)

@app.route(<span style="color:#f1fa8c">&#39;/ping&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ping_pong</span>():
    <span style="color:#ff79c6">return</span> jsonify({
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;pong!&#39;</span>
    })
</code></pre></div><p>然后更新容器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose up -d
</code></pre></div><p>怎么知道我们上面的这种方法就配置成功了呢？我们在<code>project/__init__.py</code>文件下面打印下配置信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> sys
<span style="color:#ff79c6">print</span>(app<span style="color:#ff79c6">.</span>config, <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>sys<span style="color:#ff79c6">.</span>stderr)
</code></pre></div><p>因为我们将代码挂载到容器里面的，所以直接保存就会自动加载，然后查看日志：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose logs -f users-service
</code></pre></div><p>
  <img src="/img/posts/WX20171228-171149.png" alt="print-log">


从日志中可以看出<strong>DEBUG=True，TESTING=False</strong>，证明是生效的（记得删除日志代码哦~~~）</p>
<h3 id="4-数据库安装配置a-iddatabasea">4. 数据库安装配置<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>这节课我们将来配置<code>MySQL</code>数据库，启动运行在另外一个容器中，然后把它<code>link</code>到<code>users-service</code>容器中&hellip;&hellip;</p>
<p>增加<code>Flask-SQLAlchemy</code>和<code>PyMySQL</code>到<strong>requirementx.txt</strong>文件中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Flask-SQLAlchemy==2.3.2
PyMySQL==0.8.0
</code></pre></div><p>当然要记得安装这些依赖包：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ pip install -r requirements.txt
</code></pre></div><p>然后更新<code>config.py</code>文件，添加<code>SQLAlchemy</code>数据库声明：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/config.py</span>
<span style="color:#ff79c6">import</span> os

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseConfig</span>:
    <span style="color:#f1fa8c">&#34;&#34;&#34;基础配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> False
    TESTING <span style="color:#ff79c6">=</span> False
    SQLALCHEMY_TRACK_MODIFICATIONS <span style="color:#ff79c6">=</span> False

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DevelopmentConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;开发环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> True
    SQLALCHEMY_DATABASE_URI <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;DATABASE_URL&#39;</span>)

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestingConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;测试环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> True
    TESTING <span style="color:#ff79c6">=</span> True
    SQLALCHEMY_DATABASE_URI <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;DATABASE_TEST_URL&#39;</span>)

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">ProductionConfig</span>(BaseConfig):
    <span style="color:#f1fa8c">&#34;&#34;&#34;生产环境配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> False
    SQLALCHEMY_DATABASE_URI <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;DATABASE_URL&#39;</span>)
</code></pre></div><p>接下来更新<code>__init__.py</code>文件，创建一个<code>SQLAlchemy</code>实例然后定义数据模型：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/__init__.py</span>
<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">import</span> datetime
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, jsonify
<span style="color:#ff79c6">from</span> flask_sqlalchemy <span style="color:#ff79c6">import</span> SQLAlchemy

<span style="color:#6272a4"># 初始化app</span>
app <span style="color:#ff79c6">=</span> Flask(__name__)
<span style="color:#6272a4"># 环境配置</span>
app_settings <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;APP_SETTINGS&#39;</span>)
app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(app_settings)

<span style="color:#6272a4"># 初始化数据库</span>
db <span style="color:#ff79c6">=</span> SQLAlchemy(app)

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">User</span>(db<span style="color:#ff79c6">.</span>Model):
    __tablename__ <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;users&#34;</span>
    <span style="color:#8be9fd;font-style:italic">id</span> <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>Integer, primary_key<span style="color:#ff79c6">=</span>True, autoincrement<span style="color:#ff79c6">=</span>True)
    username <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">128</span>), nullable<span style="color:#ff79c6">=</span>False)
    email <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">128</span>), nullable<span style="color:#ff79c6">=</span>False)
    active <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>Boolean(), default<span style="color:#ff79c6">=</span>False, nullable<span style="color:#ff79c6">=</span>False)
    created_at <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>DateTime, nullable<span style="color:#ff79c6">=</span>False)

    <span style="color:#ff79c6">def</span> __init__(self, username, email):
        self<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">=</span> username
        self<span style="color:#ff79c6">.</span>email <span style="color:#ff79c6">=</span> email
        self<span style="color:#ff79c6">.</span>created_at <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>utcnow()

@app.route(<span style="color:#f1fa8c">&#39;/ping&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ping_pong</span>():
    <span style="color:#ff79c6">return</span> jsonify({
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;pong!&#39;</span>
    })
</code></pre></div><p>在<code>project</code>目录下增加一个<code>db</code>的文件夹，在下面新建一个<code>create.sql</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DATABASE</span> users_prod;
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DATABASE</span> users_dev;
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DATABASE</span> users_test;
</code></pre></div><p>然后在<code>db</code>目录下面添加文件<code>Dockerfile</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> mysql:5.6</span>

<span style="color:#6272a4"># 初始化的时候运行create.sql脚本</span>
<span style="color:#ff79c6">ADD</span> create.sql /docker-entrypoint-initdb.d
</code></pre></div><p>这里我们继承官方的<code>mysql</code>镜像，在<code>docker-entrypoint-initdb.d</code>目录下面增加一个<strong>SQL</strong>文件，容器在初始化的时候就会执行这个sql文件。</p>
<p>更新<code>docker-compose.yml</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;2.1&#39;</span>

<span style="color:#ff79c6">services</span>:
  <span style="color:#ff79c6">users-db</span>:
    <span style="color:#ff79c6">container_name</span>: users-db
    <span style="color:#ff79c6">build</span>: ./project/db
    <span style="color:#ff79c6">ports</span>:
      - <span style="color:#bd93f9">3307</span>:<span style="color:#bd93f9">3306</span>
    <span style="color:#ff79c6">environment</span>:
      - MYSQL_ROOT_PASSWORD=root321
    <span style="color:#ff79c6">healthcheck</span>:
      <span style="color:#ff79c6">test</span>: exit 0

  <span style="color:#ff79c6">users-service</span>:
    <span style="color:#ff79c6">container_name</span>: users-service
    <span style="color:#ff79c6">build</span>: ./
    <span style="color:#ff79c6">volumes</span>:
      - <span style="color:#f1fa8c">&#39;.:/usr/src/app&#39;</span>
    <span style="color:#ff79c6">ports</span>:
      - <span style="color:#bd93f9">5001</span>:<span style="color:#bd93f9">5000</span> <span style="color:#6272a4"># 暴露端口 - 主机:容器</span>
    <span style="color:#ff79c6">environment</span>:
      - APP_SETTINGS=project.config.DevelopmentConfig
      - DATABASE_URL=mysql+pymysql://root:root321@users-db:3306/users_dev
      - DATABASE_TEST_URL=mysql+pymysql://root:root321@users-db:3306/users_test
    <span style="color:#ff79c6">depends_on</span>:
      <span style="color:#ff79c6">users-db</span>:
        <span style="color:#ff79c6">condition</span>: service_healthy
    <span style="color:#ff79c6">links</span>:
      - users-db
</code></pre></div><p>启动后注入环境变量<code>exit code</code>被发送后容器成功运行起来，<code>MySQL</code>将被绑定在宿主机的3307和容器的3306端口上。注意<code>DATABASE_URL</code>路径中使用的<code>mysql+pymysql</code>，因为我们使用的是<code>python3.6.x</code>版本和<code>pymysql</code>驱动。
检测：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose up -d --build
</code></pre></div><p>然后更新<code>manage.py</code>，增加创建数据库的命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> flask_script <span style="color:#ff79c6">import</span> Manager
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> app, db

manager <span style="color:#ff79c6">=</span> Manager(app)

@manager.command
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">recreate_db</span>():
    <span style="color:#f1fa8c">&#34;&#34;&#34;重新创建数据表.&#34;&#34;&#34;</span>
    db<span style="color:#ff79c6">.</span>drop_all()
    db<span style="color:#ff79c6">.</span>create_all()
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    manager<span style="color:#ff79c6">.</span>run()
</code></pre></div><p>新添加了一个<code>recrete_db</code>的命令，我们可以在命令行中执行该命令来将<code>model</code>映射到数据中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py recreate_db
</code></pre></div><p>如果一切正常的话，上面的命令能够执行成功，然后我们来验证下数据库中是否有对应的数据表了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker <span style="color:#8be9fd;font-style:italic">exec</span> -it users-db mysql -uroot -p
Enter password:
</code></pre></div><p>然后输入上面我们环境变量中设置的<code>root321</code>就登录到<code>MySQL</code>数据库中了。然后执行下面的系列命令查看数据库、查看数据表结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| users_dev          |
| users_prod         |
| users_test         |
+--------------------+
<span style="color:#bd93f9">6</span> rows in <span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#ff79c6">(</span>0.00 sec<span style="color:#ff79c6">)</span>

mysql&gt; use users_dev;
Reading table information <span style="color:#ff79c6">for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+---------------------+
| Tables_in_users_dev |
+---------------------+
| users               |
+---------------------+
<span style="color:#bd93f9">1</span> row in <span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#ff79c6">(</span>0.00 sec<span style="color:#ff79c6">)</span>

mysql&gt; desc users;
+------------+--------------+------+-----+---------+----------------+
| Field      | Type         | Null | Key | Default | Extra          |
+------------+--------------+------+-----+---------+----------------+
| id         | int<span style="color:#ff79c6">(</span>11<span style="color:#ff79c6">)</span>      | NO   | PRI | NULL    | auto_increment |
| username   | varchar<span style="color:#ff79c6">(</span>128<span style="color:#ff79c6">)</span> | NO   |     | NULL    |                |
| email      | varchar<span style="color:#ff79c6">(</span>128<span style="color:#ff79c6">)</span> | NO   |     | NULL    |                |
| active     | tinyint<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span>   | NO   |     | NULL    |                |
| created_at | datetime     | NO   |     | NULL    |                |
+------------+--------------+------+-----+---------+----------------+
<span style="color:#bd93f9">5</span> rows in <span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#ff79c6">(</span>0.00 sec<span style="color:#ff79c6">)</span>
</code></pre></div><p>从上面的命令我们可以看到<code>model</code>和我们的数据表已经映射成功了。</p>
<h3 id="5-测试a-idtesta">5. 测试<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>按照我们平时的开发习惯，是不是接下来就应该开发业务代码了？当然这样是可以的，但是我们这里不这样做，我们让测试先行，让测试来驱动开发，这样有什么好处呢？<code>TDD</code>最重要的功能就是保障代码的正确性，能够迅速发现、定位<code>bug</code>。关于<code>TDD</code>更多的知识可以自行<code>Google</code>。提供一个篇<strong>IBM</strong>关于<code>TDD</code>介绍的文章：<a href="https://www.ibm.com/developerworks/cn/linux/l-tdd/">浅谈测试驱动开发（TDD）</a></p>
<p>首先新增测试用的依赖包：<code>Flask-Testing</code>到<code>requirements.txt</code>文件下面（记得用<code>pip</code>命令安装哦~）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Flask-Testing==0.7.1
</code></pre></div><p>在<code>project</code>目录下面新建一个<code>tests</code>的目录，然后在该目录使用下面新增几个文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ touch __init__.py base.py test_config.py test_users.py
</code></pre></div><p>如果你对<code>Flask-Testing</code>还不太熟悉，在编写测试文件之前，可以先简单查<a href="https://flask-testing.readthedocs.io/en/latest/">看下文档</a>。</p>
<p>更新<code>base.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/tests/base.py</span>
<span style="color:#ff79c6">from</span> flask_testing <span style="color:#ff79c6">import</span> TestCase
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> app, db

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseTestCase</span>(TestCase):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_app</span>(self):
        app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(<span style="color:#f1fa8c">&#39;project.config.TestingConfig&#39;</span>)
        <span style="color:#ff79c6">return</span> app

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">setUp</span>(self):
        db<span style="color:#ff79c6">.</span>create_all()
        db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">tearDown</span>(self):
        db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>remove()
        db<span style="color:#ff79c6">.</span>drop_all()
</code></pre></div><p>首先，我们确保测试使用的数据库<code>URI</code>不是生产环境的，避免对线上环境产生任何影响。每次测试的时候创建数据表、完成后删除表，确保能够清理测试数据。</p>
<blockquote>
<p>必须指定一个create_app 方法，并且返回flask app 实例，如果没有定义将会抛出<strong>NotImplementedError</strong>异常。</p>
</blockquote>
<p>另外在<code>tearDown</code>方法中增加<code>db.session.remove()</code>方法，这样能够确保每次测试完成的时候能够将<code>SQLAlchemy</code>的<strong>session</strong>属性移除掉，在下一次测试的时候始终是一个新的<strong>session</strong>。</p>
<p>更新<code>test_config.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> current_app
<span style="color:#ff79c6">from</span> flask_testing <span style="color:#ff79c6">import</span> TestCase
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> app

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestDevelopmentConfig</span>(TestCase):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_app</span>(self):
        app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(<span style="color:#f1fa8c">&#39;project.config.DevelopmentConfig&#39;</span>)
        <span style="color:#ff79c6">return</span> app

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_app_is_development</span>(self):
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;SECRET_KEY&#39;</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;secret&#39;</span>)
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;DEBUG&#39;</span>] <span style="color:#ff79c6">is</span> True)
        self<span style="color:#ff79c6">.</span>assertFalse(current_app <span style="color:#ff79c6">is</span> None)
        self<span style="color:#ff79c6">.</span>assertTrue(
            app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#ff79c6">==</span>
            <span style="color:#f1fa8c">&#39;mysql+pymysql://root:root321@users-db:3306/users_dev&#39;</span>
        )

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestTestingConfig</span>(TestCase):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_app</span>(self):
        app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(<span style="color:#f1fa8c">&#39;project.config.TestingConfig&#39;</span>)
        <span style="color:#ff79c6">return</span> app

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_app_is_testing</span>(self):
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;SECRET_KEY&#39;</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;secret&#39;</span>)
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;DEBUG&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;TESTING&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertFalse(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertTrue(
            app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#ff79c6">==</span>
            <span style="color:#f1fa8c">&#39;mysql+pymysql://root:root321@users-db:3306/users_test&#39;</span>
        )

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestProductionConfig</span>(TestCase):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_app</span>(self):
        app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(<span style="color:#f1fa8c">&#39;project.config.ProductionConfig&#39;</span>)
        <span style="color:#ff79c6">return</span> app

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_app_is_production</span>(self):
        self<span style="color:#ff79c6">.</span>assertTrue(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;SECRET_KEY&#39;</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;secret&#39;</span>)
        self<span style="color:#ff79c6">.</span>assertFalse(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;DEBUG&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertFalse(app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;TESTING&#39;</span>])
</code></pre></div><p>更新<code>test_users.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> json
<span style="color:#ff79c6">from</span> project.tests.base <span style="color:#ff79c6">import</span> BaseTestCase

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestUserService</span>(BaseTestCase):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_users</span>(self):
        <span style="color:#f1fa8c">&#34;&#34;&#34;确保ping的服务正常.&#34;&#34;&#34;</span>
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/ping&#39;</span>)
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">200</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;pong&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;success&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])
</code></pre></div><p>然后我们在<code>manage.py</code>中新增一个测试的命令行支持：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> unittest
<span style="color:#ff79c6">from</span> flask_script <span style="color:#ff79c6">import</span> Manager
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> app, db

manager <span style="color:#ff79c6">=</span> Manager(app)

@manager.command
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">recreate_db</span>():
    <span style="color:#f1fa8c">&#34;&#34;&#34;重新创建数据表.&#34;&#34;&#34;</span>
    db<span style="color:#ff79c6">.</span>drop_all()
    db<span style="color:#ff79c6">.</span>create_all()
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()

@manager.command
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
    <span style="color:#f1fa8c">&#34;&#34;&#34;运行测试.&#34;&#34;&#34;</span>
    tests <span style="color:#ff79c6">=</span> unittest<span style="color:#ff79c6">.</span>TestLoader()<span style="color:#ff79c6">.</span>discover(<span style="color:#f1fa8c">&#39;project/tests&#39;</span>, pattern<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;test_*.py&#39;</span>)
    result <span style="color:#ff79c6">=</span> unittest<span style="color:#ff79c6">.</span>TextTestRunner(verbosity<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>)<span style="color:#ff79c6">.</span>run(tests)
    <span style="color:#ff79c6">if</span> result<span style="color:#ff79c6">.</span>wasSuccessful():
        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>
    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1</span>

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    manager<span style="color:#ff79c6">.</span>run()
</code></pre></div><p><code>unittest</code>支持非常简单的测试发现，为了兼容测试发现，所有的测试文件(test_xxx.py)必须是可以从项目的顶级目录导入的包或者模块，我们这里就是利用<code>TestLoader.discover()</code>方法去发现<strong>project/tests</strong>包下面的所有的<strong>test_xxx.py</strong>测试文件。然后使用<strong>TextTestRunner</strong>用来执行测试用例，对测试进行编排并把结果返回给用户。</p>
<p>如果是单个的测试文件，推荐你将所有的测试方法放在同一个文件中，这样能够方便的使用<code>unittest.main()</code>方法执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> unittest
<span style="color:#ff79c6">import</span> flask_testing

<span style="color:#6272a4"># TODO your test cases</span>

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    unittest<span style="color:#ff79c6">.</span>main()
</code></pre></div><p>然后可以执行命令<strong>python test_xxx.py</strong>进行测试。</p>
<p>由于我们这里有<code>test_config.py</code>和<code>test_users.py</code>两个业务不一样的测试用例，所以我们使用<code>test runner</code>来收集所有的测试结果并生成最后的测试报告。</p>
<p>由于我们更新了依赖包，所以需要重新构建镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose up -d --build
</code></pre></div><p>然后运行测试命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
</code></pre></div><p>然后我们可以看到类似于下面的测试没有通过的提示信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">======================================================================</span>
FAIL: test_app_is_development <span style="color:#ff79c6">(</span>test_config.TestDevelopmentConfig<span style="color:#ff79c6">)</span>
----------------------------------------------------------------------
Traceback <span style="color:#ff79c6">(</span>most recent call last<span style="color:#ff79c6">)</span>:
  File <span style="color:#f1fa8c">&#34;/usr/src/app/project/tests/test_config.py&#34;</span>, line 13, in test_app_is_development
    self.assertTrue<span style="color:#ff79c6">(</span>app.config<span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;SECRET_KEY&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;secret&#39;</span><span style="color:#ff79c6">)</span>
AssertionError: False is not <span style="color:#8be9fd;font-style:italic">true</span>
</code></pre></div><p>这是因为我们的<code>app.config</code>中还没有<strong>SECRET_KEY</strong>这个key，所以<code>assertTrue</code>肯定是不会通过的，然后我们在<code>config.py</code>的<strong>BaseConfig</strong>类中新增<strong>SECRET_KEY</strong>属性：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseConfig</span>:
    <span style="color:#f1fa8c">&#34;&#34;&#34;基础配置&#34;&#34;&#34;</span>
    DEBUG <span style="color:#ff79c6">=</span> False
    TESTING <span style="color:#ff79c6">=</span> False
    SQLALCHEMY_TRACK_MODIFICATIONS <span style="color:#ff79c6">=</span> False
    SECRET_KEY <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;secret&#39;</span>
</code></pre></div><p>重新执行测试命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
Starting users-db ... <span style="color:#ff79c6">done</span>
test_app_is_development <span style="color:#ff79c6">(</span>test_config.TestDevelopmentConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_production <span style="color:#ff79c6">(</span>test_config.TestProductionConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_testing <span style="color:#ff79c6">(</span>test_config.TestTestingConfig<span style="color:#ff79c6">)</span> ... ok
test_users <span style="color:#ff79c6">(</span>test_users.TestUserService<span style="color:#ff79c6">)</span>
确保ping的服务正常. ... ok

----------------------------------------------------------------------
Ran <span style="color:#bd93f9">4</span> tests in 0.124s

OK
</code></pre></div><p>测试通过~~~</p>
<h3 id="6-flask-blueprint蓝图a-idblueprinta">6. Flask Blueprint(蓝图)<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>上节课完成了我们的基本测试，这节课我们来用<code>Blueprint</code>(蓝图)来对项目进行重构。</p>
<blockquote>
<p>还不了解<code>Blueprint</code>？可以先查看<a href="http://flask.pocoo.org/docs/0.12/blueprints/">flask blueprint 文档</a>。简单来说，<code>Flask Blueprint</code>提供了模块化管理程序路由的功能，使程序结构清晰、简单易懂。还是不太明白？没关系，这节课完成后我相信你一定会明白的~</p>
</blockquote>
<p>在<code>project</code>目录下面新增<code>api</code>的目录，然后同样的需要在该目录下面新建几个文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ touch __init__.py models.py views.py
</code></pre></div><p>然后更新<code>views.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/api/views.py</span>
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Blueprint, jsonify

users_blueprint <span style="color:#ff79c6">=</span> Blueprint(<span style="color:#f1fa8c">&#39;users&#39;</span>, __name__)

@users_blueprint.route(<span style="color:#f1fa8c">&#39;/ping&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ping_pong</span>():
    <span style="color:#ff79c6">return</span> jsonify({
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;pong!&#39;</span>
    })
</code></pre></div><p>我们创建了一个<code>users_blueprint</code>的<code>Blueprint</code>实例，然后将该实例绑定到了<code>ping_pong()</code>方法上，这有什么用？继续往下看&hellip;&hellip;</p>
<p>然后更新<code>models.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/api/models.py</span>
<span style="color:#ff79c6">import</span> datetime
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> db

<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">User</span>(db<span style="color:#ff79c6">.</span>Model):
    __tablename__ <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;users&#34;</span>
    <span style="color:#8be9fd;font-style:italic">id</span> <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>Integer, primary_key<span style="color:#ff79c6">=</span>True, autoincrement<span style="color:#ff79c6">=</span>True)
    username <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">128</span>), nullable<span style="color:#ff79c6">=</span>False)
    email <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">128</span>), nullable<span style="color:#ff79c6">=</span>False)
    active <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>Boolean(), default<span style="color:#ff79c6">=</span>False, nullable<span style="color:#ff79c6">=</span>False)
    created_at <span style="color:#ff79c6">=</span> db<span style="color:#ff79c6">.</span>Column(db<span style="color:#ff79c6">.</span>DateTime, nullable<span style="color:#ff79c6">=</span>False)

    <span style="color:#ff79c6">def</span> __init__(self, username, email):
        self<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">=</span> username
        self<span style="color:#ff79c6">.</span>email <span style="color:#ff79c6">=</span> email
        self<span style="color:#ff79c6">.</span>created_at <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>utcnow()
</code></pre></div><p>我们可以看到上面的内容和<code>project/__init__.py</code>文件中的<strong>User</strong>类是一模一样的，没错，我们只是将这个地方代码分拆了而已，下面继续更新<code>project/__init__.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># project/__init__.py</span>
<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, jsonify
<span style="color:#ff79c6">from</span> flask_sqlalchemy <span style="color:#ff79c6">import</span> SQLAlchemy

<span style="color:#6272a4"># 初始化数据库</span>
db <span style="color:#ff79c6">=</span> SQLAlchemy()

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_app</span>():
    <span style="color:#6272a4"># 初始化应用</span>
    app <span style="color:#ff79c6">=</span> Flask(__name__)
    <span style="color:#6272a4"># 环境配置</span>
    app_settings <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;APP_SETTINGS&#39;</span>)
    app<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>from_object(app_settings)
    <span style="color:#6272a4"># 安装扩展</span>
    db<span style="color:#ff79c6">.</span>init_app(app)
    <span style="color:#6272a4"># 注册blueprint</span>
    <span style="color:#ff79c6">from</span> project.api.views <span style="color:#ff79c6">import</span> users_blueprint
    app<span style="color:#ff79c6">.</span>register_blueprint(users_blueprint)
    <span style="color:#ff79c6">return</span> app
</code></pre></div><p>注意这里我们将实例化app的工作提取到了<code>create_app</code>的方法里面去，这是因为<code>users_blueprint</code>里面需要引用到当前文件下面的<code>db</code>实例，如果不把app放置到方法中去的话就会造成<code>循环引用</code>，什么意思？简单来说就是你中有我，我中有你，这对于程序来说是无法做出判断的~</p>
<p>接下来我们需要把所有其他文件引用<code>project</code>下面的app 的实例的都要替换掉(包括测试文件)：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> create_app

app <span style="color:#ff79c6">=</span> create_app()
</code></pre></div><p>更改完成以后我们重新构建镜像、创建数据库，最重要的是什么？<strong>测试</strong>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose up -d
users-db is up-to-date
Starting users-service ...
Starting users-service ... <span style="color:#ff79c6">done</span>
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py recreate_db
Starting users-db ... <span style="color:#ff79c6">done</span>
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
Starting users-db ... <span style="color:#ff79c6">done</span>
test_app_is_development <span style="color:#ff79c6">(</span>test_config.TestDevelopmentConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_production <span style="color:#ff79c6">(</span>test_config.TestProductionConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_testing <span style="color:#ff79c6">(</span>test_config.TestTestingConfig<span style="color:#ff79c6">)</span> ... ok
test_users <span style="color:#ff79c6">(</span>test_users.TestUserService<span style="color:#ff79c6">)</span>
确保ping的服务正常. ... ok

----------------------------------------------------------------------
Ran <span style="color:#bd93f9">4</span> tests in 0.086s

OK
</code></pre></div><p>一切正常~~~</p>
<p>接下来我们根据<code>RESTful</code>的最佳实践利用<code>TDD</code>增加3个路由：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Endpoint</th>
<th style="text-align:left">HTTP Method</th>
<th style="text-align:left">CRUD Method</th>
<th style="text-align:left">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">/users</td>
<td style="text-align:left">GET</td>
<td style="text-align:left">查询</td>
<td style="text-align:left">获取所有用户</td>
</tr>
<tr>
<td style="text-align:left">/users/:id</td>
<td style="text-align:left">GET</td>
<td style="text-align:left">查询</td>
<td style="text-align:left">获取单个用户</td>
</tr>
<tr>
<td style="text-align:left">/users</td>
<td style="text-align:left">POST</td>
<td style="text-align:left">新增</td>
<td style="text-align:left">新增用户</td>
</tr>
</tbody>
</table>
<p>首先，在<code>project/tests/test_users.py</code>文件的<code>TestUserService</code>类中新增一个测试新增用户的方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_add_user</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;确保能够正确添加一个用户的用户到数据库中&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>)),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>,
        )
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">201</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;qikqiak@gmail.com was added&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;success&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])
</code></pre></div><p>我们现在来执行测试肯定是不会通过的，因为路由<code>/users</code>还没实现的，所以接着我们在<code>project/api/views.py</code>中新增一个<code>/users</code>的处理方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4"># 注意要导入request</span>
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Blueprint, jsonify, request, render_template

@users_blueprint.route(<span style="color:#f1fa8c">&#39;/users&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;POST&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">add_user</span>():
    <span style="color:#6272a4"># 获取POST的数据</span>
    post_data <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>get_json()
    email <span style="color:#ff79c6">=</span> post_data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;email&#39;</span>)
    user <span style="color:#ff79c6">=</span> User(username<span style="color:#ff79c6">=</span>post_data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;username&#39;</span>), email<span style="color:#ff79c6">=</span>email)
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(user)
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()
    response_data <span style="color:#ff79c6">=</span> {
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> was added!&#39;</span> <span style="color:#ff79c6">%</span> email
    }
    <span style="color:#ff79c6">return</span> jsonify(response_data), <span style="color:#bd93f9">201</span>
</code></pre></div><blockquote>
<p>注意上面我们<code>add_user</code>方法最终返回的数据，是从我们上面设计的测试代码中来的，这就是所谓的<strong>测试驱动</strong>我们的开发~</p>
</blockquote>
<p>然后执行测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
Starting users-db ... <span style="color:#ff79c6">done</span>
test_app_is_development <span style="color:#ff79c6">(</span>test_config.TestDevelopmentConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_production <span style="color:#ff79c6">(</span>test_config.TestProductionConfig<span style="color:#ff79c6">)</span> ... ok
test_app_is_testing <span style="color:#ff79c6">(</span>test_config.TestTestingConfig<span style="color:#ff79c6">)</span> ... ok
test_add_user <span style="color:#ff79c6">(</span>test_users.TestUserService<span style="color:#ff79c6">)</span>
确保能够正确添加一个用户的用户到数据库中 ... ok
test_users <span style="color:#ff79c6">(</span>test_users.TestUserService<span style="color:#ff79c6">)</span>
确保ping的服务正常. ... ok

----------------------------------------------------------------------
Ran <span style="color:#bd93f9">5</span> tests in 0.157s

OK
</code></pre></div><p>测试通过~~~</p>
<p>但是还没完呢？现在我们的代码还不够健壮，如果程序中出现了错误或者异常该怎么办呢？比如：</p>
<ol>
<li>POST 的数据为空</li>
<li>POST 的数据无效 - 比如JSON 对象是空的或者包含一个错误的key</li>
<li>如果添加的用户在数据中已经存在？</li>
</ol>
<p>来对这些用例添加一些测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_add_user_invalid_json</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;如果JSON对象为空，确保抛出一个错误。&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>()),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>
        )
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">400</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;Invalid payload&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_add_user_invalid_json_keys</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;如果JSON对象中没有username或email，确保抛出一个错误。&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>(email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>)),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>
        )
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">400</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;Invalid payload&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])

    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>)),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>
        )
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">400</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;Invalid payload&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_add_user_duplicate_user</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;如果邮件已经存在确保抛出一个错误。&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>(
                username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>,
                email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>
            )),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>
        )
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/users&#39;</span>,
            data<span style="color:#ff79c6">=</span>json<span style="color:#ff79c6">.</span>dumps(<span style="color:#8be9fd;font-style:italic">dict</span>(
                username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>,
                email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>
            )),
            content_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;application/json&#39;</span>
        )
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">400</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;Sorry. That email already exists.&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])
</code></pre></div><p>现在我们支持测试命令，肯定是不会通过的，因为还没更新handler 呢：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> sqlalchemy <span style="color:#ff79c6">import</span> exc

@users_blueprint.route(<span style="color:#f1fa8c">&#39;/users&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;POST&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">add_user</span>():
    <span style="color:#6272a4"># 获取POST的数据</span>
    post_data <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>get_json()
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> post_data:
        response_data <span style="color:#ff79c6">=</span> {
            <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;fail&#39;</span>,
            <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;Invalid payload.&#39;</span>
        }
        <span style="color:#ff79c6">return</span> jsonify(response_data), <span style="color:#bd93f9">400</span>
    email <span style="color:#ff79c6">=</span> post_data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;email&#39;</span>)
    username <span style="color:#ff79c6">=</span> post_data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;username&#39;</span>)
    <span style="color:#ff79c6">try</span>:
        user <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">.</span>query<span style="color:#ff79c6">.</span>filter_by(email<span style="color:#ff79c6">=</span>email)<span style="color:#ff79c6">.</span>first()
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> user:
            <span style="color:#6272a4"># 证明数据库中不存在该email的用户，可以添加</span>
            db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(User(username<span style="color:#ff79c6">=</span>username, email<span style="color:#ff79c6">=</span>email))
            db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()
            response_data <span style="color:#ff79c6">=</span> {
                <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
                <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> was added!&#39;</span> <span style="color:#ff79c6">%</span> email
            }
            <span style="color:#ff79c6">return</span> jsonify(response_data), <span style="color:#bd93f9">201</span>
        <span style="color:#6272a4"># 证明该email已经存在</span>
        response_data <span style="color:#ff79c6">=</span> {
            <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;fail&#39;</span>,
            <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;Sorry. That email already exists.&#39;</span>
        }
        <span style="color:#ff79c6">return</span> jsonify(response_data), <span style="color:#bd93f9">400</span>
    <span style="color:#ff79c6">except</span> exc<span style="color:#ff79c6">.</span>IntegrityError <span style="color:#ff79c6">as</span> e:
        db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>rollback()  <span style="color:#6272a4"># 出现异常了，回滚</span>
        response_data <span style="color:#ff79c6">=</span> {
            <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;fail&#39;</span>,
            <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;Invalid payload.&#39;</span>
        }
        <span style="color:#ff79c6">return</span> jsonify(response_data), <span style="color:#bd93f9">400</span>
</code></pre></div><p>然后执行我们的测试命令，现在就能够测试通过了，如果出现了问题那么你应该仔细看看你的代码了~</p>
<p>接下来处理另外两个请求。</p>
<p>获取单个用户信息，还是先进行测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> project.api.models <span style="color:#ff79c6">import</span> User
<span style="color:#ff79c6">from</span> project <span style="color:#ff79c6">import</span> db

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_get_user</span>(self):
    user <span style="color:#ff79c6">=</span> User(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>)
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(user)
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/users/</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> user<span style="color:#ff79c6">.</span>id)
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">200</span>)
        self<span style="color:#ff79c6">.</span>assertTrue(<span style="color:#f1fa8c">&#39;created_at&#39;</span> <span style="color:#ff79c6">in</span> data[<span style="color:#f1fa8c">&#39;data&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;cnych&#39;</span>, data[<span style="color:#f1fa8c">&#39;data&#39;</span>][<span style="color:#f1fa8c">&#39;username&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>, data[<span style="color:#f1fa8c">&#39;data&#39;</span>][<span style="color:#f1fa8c">&#39;email&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;success&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])
</code></pre></div><p>然后来编写获取单个用户请求的处理函数，更新<code>project/api/views.py</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@users_blueprint.route(<span style="color:#f1fa8c">&#39;/users/&lt;user_id&gt;&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_user</span>(user_id):
    <span style="color:#f1fa8c">&#34;&#34;&#34;获取某用户的详细信息&#34;&#34;&#34;</span>
    user <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">.</span>query<span style="color:#ff79c6">.</span>filter_by(<span style="color:#8be9fd;font-style:italic">id</span><span style="color:#ff79c6">=</span>user_id)<span style="color:#ff79c6">.</span>first()
    response_object <span style="color:#ff79c6">=</span> {
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
        <span style="color:#f1fa8c">&#39;data&#39;</span>: {
            <span style="color:#f1fa8c">&#39;username&#39;</span>: user<span style="color:#ff79c6">.</span>username,
            <span style="color:#f1fa8c">&#39;email&#39;</span>: user<span style="color:#ff79c6">.</span>email,
            <span style="color:#f1fa8c">&#39;created_at&#39;</span>: user<span style="color:#ff79c6">.</span>created_at
        }
    }
    <span style="color:#ff79c6">return</span> jsonify(response_object), <span style="color:#bd93f9">200</span>
</code></pre></div><p>现在执行测试命令，测试能够通过了，那应该有哪一些错误处理的场景呢：</p>
<ul>
<li>没有提供id</li>
<li>id不存在</li>
</ul>
<p>然后我们来针对上面两种场景添加测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_get_user_no_id</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;如果没有id的时候抛出异常。&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/users/xxx&#39;</span>)
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">400</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;Param id error&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_get_user_incorrect_id</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;如果ID不存在则要抛出异常&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/users/-1&#39;</span>)
        data <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(response<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>decode())
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">404</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;User does not exist&#39;</span>, data[<span style="color:#f1fa8c">&#39;message&#39;</span>])
        self<span style="color:#ff79c6">.</span>assertEqual(<span style="color:#f1fa8c">&#39;fail&#39;</span>, data[<span style="color:#f1fa8c">&#39;status&#39;</span>])
</code></pre></div><p>然后根据上面我们的测试代码来更新<code>get_user</code>函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@users_blueprint.route(<span style="color:#f1fa8c">&#39;/users/&lt;user_id&gt;&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_user</span>(user_id):
    <span style="color:#f1fa8c">&#34;&#34;&#34;获取某用户的详细信息&#34;&#34;&#34;</span>
    response_object <span style="color:#ff79c6">=</span> {
        <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;fail&#39;</span>,
        <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;User does not exist&#39;</span>
    }
    code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">404</span>
    <span style="color:#ff79c6">try</span>:
        user <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">.</span>query<span style="color:#ff79c6">.</span>filter_by(<span style="color:#8be9fd;font-style:italic">id</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>(user_id))<span style="color:#ff79c6">.</span>first()
        <span style="color:#ff79c6">if</span> user:
            response_object <span style="color:#ff79c6">=</span> {
                <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;success&#39;</span>,
                <span style="color:#f1fa8c">&#39;data&#39;</span>: {
                    <span style="color:#f1fa8c">&#39;username&#39;</span>: user<span style="color:#ff79c6">.</span>username,
                    <span style="color:#f1fa8c">&#39;email&#39;</span>: user<span style="color:#ff79c6">.</span>email,
                    <span style="color:#f1fa8c">&#39;created_at&#39;</span>: user<span style="color:#ff79c6">.</span>created_at
                }
            }
            code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">200</span>
    <span style="color:#ff79c6">except</span> ValueError:
        response_object <span style="color:#ff79c6">=</span> {
            <span style="color:#f1fa8c">&#39;status&#39;</span>: <span style="color:#f1fa8c">&#39;fail&#39;</span>,
            <span style="color:#f1fa8c">&#39;message&#39;</span>: <span style="color:#f1fa8c">&#39;Param id error&#39;</span>
        }
        code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">400</span>
    <span style="color:#ff79c6">finally</span>:
        <span style="color:#ff79c6">return</span> jsonify(response_object), code
</code></pre></div><p>然后继续执行我们的测试命令，通过~~~</p>
<p>然后是获取所有的用户列表的请求，这节就让我们的读者朋友自己来动手实践吧，最终代码我们会同步到<code>github</code>上去的，记住要用<code>TDD</code>的思想，先写测试代码，然后编写我们的网络请求函数，然后编写一些异常场景下面的测试代码，继续增强我们的请求函数，再测试。</p>
<p>上面的步骤完成后，我们试着在浏览器中打开<a href="http://127.0.0.1:5001/users">http://127.0.0.1:5001/users</a>接口，不出意外的话我们会看到如下的<code>json</code>信息输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;data&#34;</span>: {
        <span style="color:#ff79c6">&#34;users&#34;</span>: []
    },
    <span style="color:#ff79c6">&#34;status&#34;</span>: <span style="color:#f1fa8c">&#34;success&#34;</span>
}
</code></pre></div><p>这是因为我们的数据库中还没有任何的数据，所以肯定这里得到的是一个空的数据列表。为了测试方便，我们在<code>manage.py</code>文件中增加一个命令来添加一些测试数据吧：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> project.api.models <span style="color:#ff79c6">import</span> User
@manager.command
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">seed_db</span>():
    <span style="color:#f1fa8c">&#34;&#34;&#34;Seeds the database.&#34;&#34;&#34;</span>
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(User(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;qikqiak@gmail.com&#34;</span>))
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(User(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;chyang&#39;</span>, email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;icnych@gmail.com&#34;</span>))
    db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()
</code></pre></div><p>然后我们在命令行中执行<code>seed_db</code>命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose run users-service python manage.py seed_db
</code></pre></div><p>执行成功后，我们再次在浏览器中打开上面的接口，已经能够看到用户列表信息了。

  <img src="/img/posts/WX20171230-144052.jpg" alt="用户列表">

</p>
<h3 id="7-部署a-iddeploya">7. 部署<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>上面的课程我们已经完成了测试和3个<code>API</code>接口的开发，现在我们来完成部署我们的应用。</p>
<p>首先在项目根目录新建一个<code>docker-compose-prod.yml</code>的文件，将<code>docker-compose.yml</code>文件的内容全部拷贝过来，然后去掉<strong>users-service</strong>下面的<code>volumes</code>，因为这是我们在开发阶段便于调试，将代码挂载到容器中的，生产环境就需要这样做了，然后就是需要将环境变量更改成生产环境的配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">environment</span>:
  - APP_SETTINGS=project.config.ProductionConfig
  - DATABASE_URL=mysql+pymysql://root:root321@users-db:3306/users_prod
  - DATABASE_TEST_URL=mysql+pymysql://root:root321@users-db:3306/users_test
</code></pre></div><p>然后执行构建镜像、创建数据库、添加初始数据、测试等命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml up -d --build
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml run users-service python manage.py recreate_db
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml run users-service python manage.py seed_db
<span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
</code></pre></div><p>测试阶段<code>test_app_is_development</code>这个测试用例肯定不会通过的，因为现在是生产环境了。</p>
<p>在生产环境我们一般使用<code>Gunicorn</code>来处理我们的网络请求，在<code>requirements.txt</code>文件中添加<code>gunicorn==19.7.1</code>，然后安装。安装完成后，在<code>docker-compose-prod.yml</code>文件中的<code>users-service</code>区域增加一条命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">command</span>: gunicorn -b 0.0.0.0:5000 manage:app
</code></pre></div><p><code>command</code>会覆盖上面<code>Dockerfile</code>中的<code>CMD</code>命令。重新构建镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml up -d --build
</code></pre></div><p>由于增加了新的依赖文件，所以我们需要重新构建，<code>--build</code>是必须的。</p>
<p>接下来我们来安装<code>Nginx</code>，对我们的网络请求进行反向代理，提高我们接口的性能。在项目根目录下面新建一个<code>nginx</code>的文件夹，然后在该目录中新增<code>Dockerfile</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">FROM nginx:1.13.0

RUN rm /etc/nginx/conf.d/default.conf
ADD /flask.conf /etc/nginx/conf.d
</code></pre></div><p>然后在当前目录新建一个<code>flask.conf</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">server {
    listen 80;
    location / {
        proxy_pass http://users-service:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre></div><p>上面是一个普通的<code>nginx</code>配置文件，意思是从80端口来的请求都转发到后端的<code>http://users-service:5000</code>服务上，后端的<code>users-service</code>服务就是上面我们用<code>gunicorn</code>启动的服务，更多的<code>nginx</code>资料，可以<code>Google</code>查询。</p>
<p>接下来我们将我们的<code>nginx</code>服务添加到<code>docker-compose-prod.yml</code>文件中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">nginx</span>:
  <span style="color:#ff79c6">container_name</span>: nginx
  <span style="color:#ff79c6">build</span>: ./nginx/
  <span style="color:#ff79c6">restart</span>: always
  <span style="color:#ff79c6">ports</span>:
    - <span style="color:#bd93f9">80</span>:<span style="color:#bd93f9">80</span>
  <span style="color:#ff79c6">depends_on</span>:
    <span style="color:#ff79c6">users-service</span>:
      <span style="color:#ff79c6">condition</span>: service_started
  <span style="color:#ff79c6">links</span>:
    - users-service
</code></pre></div><p>然后将<code>users-service</code>区域中的端口暴露改成只暴露容器端口，因为主机不需要使用了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">expose</span>:
  - <span style="color:#f1fa8c">&#39;5000&#39;</span>
</code></pre></div><p>最后重新构建<code>Docker</code>镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml up -d --build
</code></pre></div><p>构建成功后，我们就可以通过你机器的IP 来访问我们的服务了，如果你有域名的话，就可以将你的域名解析到你主机的IP 上，然后就可以愉快的用域名进行访问我们的服务了，Done!</p>
<h3 id="8-jinja模板a-idjinjaa">8. Jinja模板<!-- raw HTML omitted --><!-- raw HTML omitted --></h3>
<p>接下来我们学习下服务端模板的使用，在<code>project/api/views.py</code>文件中增加一个新的路由处理函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Blueprint, jsonify, request, render_template
@users_blueprint.route(<span style="color:#f1fa8c">&#39;/&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">index</span>():
    <span style="color:#ff79c6">return</span> render_template(<span style="color:#f1fa8c">&#39;index.html&#39;</span>)
</code></pre></div><p>然后更新下<code>Blueprint</code>，增加对模板的配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">users_blueprint <span style="color:#ff79c6">=</span> Blueprint(<span style="color:#f1fa8c">&#39;users&#39;</span>, __name__, template_folder<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;./templates&#39;</span>)
</code></pre></div><p>然后在<code>project/api</code>目录下增加一个<code>templates</code>的文件夹，在该文件夹下面添加一个<code>index.html</code>的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#ff79c6">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#ff79c6">html</span> <span style="color:#50fa7b">lang</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;en&#34;</span>&gt;
&lt;<span style="color:#ff79c6">head</span>&gt;
    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">charset</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>&gt;
    &lt;<span style="color:#ff79c6">title</span>&gt;Flask microservice app on Docker&lt;/<span style="color:#ff79c6">title</span>&gt;
    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;author&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>&gt;
    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;description&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>&gt;
    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;viewport&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;width=device-width,initial-scale=1&#34;</span>&gt;
    <span style="color:#6272a4">&lt;!-- styles --&gt;</span>
    &lt;<span style="color:#ff79c6">link</span> <span style="color:#50fa7b">href</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&#34;</span> <span style="color:#50fa7b">rel</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;stylesheet&#34;</span>&gt;
    {% block css %}{% endblock %}
&lt;/<span style="color:#ff79c6">head</span>&gt;
&lt;<span style="color:#ff79c6">body</span>&gt;
&lt;<span style="color:#ff79c6">div</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;container&#34;</span>&gt;
  &lt;<span style="color:#ff79c6">div</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;row&#34;</span>&gt;
    &lt;<span style="color:#ff79c6">div</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;col-md-4&#34;</span>&gt;
      &lt;<span style="color:#ff79c6">br</span>&gt;
      &lt;<span style="color:#ff79c6">h1</span>&gt;All Users&lt;/<span style="color:#ff79c6">h1</span>&gt;
      &lt;<span style="color:#ff79c6">hr</span>&gt;&lt;<span style="color:#ff79c6">br</span>&gt;
      &lt;<span style="color:#ff79c6">form</span> <span style="color:#50fa7b">action</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/&#34;</span> <span style="color:#50fa7b">method</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;POST&#34;</span>&gt;
        &lt;<span style="color:#ff79c6">div</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;form-group&#34;</span>&gt;
          &lt;<span style="color:#ff79c6">input</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;username&#34;</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;form-control input-lg&#34;</span> <span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;text&#34;</span> <span style="color:#50fa7b">placeholder</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Enter a username&#34;</span> <span style="color:#50fa7b">required</span>&gt;
        &lt;/<span style="color:#ff79c6">div</span>&gt;
        &lt;<span style="color:#ff79c6">div</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;form-group&#34;</span>&gt;
          &lt;<span style="color:#ff79c6">input</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;email&#34;</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;form-control input-lg&#34;</span> <span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;email&#34;</span> <span style="color:#50fa7b">placeholder</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Enter an email address&#34;</span> <span style="color:#50fa7b">required</span>&gt;
        &lt;/<span style="color:#ff79c6">div</span>&gt;
        &lt;<span style="color:#ff79c6">input</span> <span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;submit&#34;</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;btn btn-primary btn-lg btn-block&#34;</span> <span style="color:#50fa7b">value</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Submit&#34;</span>&gt;
      &lt;/<span style="color:#ff79c6">form</span>&gt;
      &lt;<span style="color:#ff79c6">br</span>&gt;
      &lt;<span style="color:#ff79c6">hr</span>&gt;
      &lt;<span style="color:#ff79c6">div</span>&gt;
        {% if users %}
          {% for user in users %}
            &lt;<span style="color:#ff79c6">h4</span> <span style="color:#50fa7b">class</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;well&#34;</span>&gt;&lt;<span style="color:#ff79c6">strong</span>&gt;{{user.username}}&lt;/<span style="color:#ff79c6">strong</span>&gt; - &lt;<span style="color:#ff79c6">em</span>&gt;{{user.created_at.strftime(&#39;%Y-%m-%d&#39;)}}&lt;/<span style="color:#ff79c6">em</span>&gt;&lt;/<span style="color:#ff79c6">h4</span>&gt;
          {% endfor %}
        {% else %}
          &lt;<span style="color:#ff79c6">p</span>&gt;No users!&lt;/<span style="color:#ff79c6">p</span>&gt;
        {% endif %}
      &lt;/<span style="color:#ff79c6">div</span>&gt;
    &lt;/<span style="color:#ff79c6">div</span>&gt;
  &lt;/<span style="color:#ff79c6">div</span>&gt;
&lt;/<span style="color:#ff79c6">div</span>&gt;
<span style="color:#6272a4">&lt;!-- scripts --&gt;</span>
&lt;<span style="color:#ff79c6">script</span> <span style="color:#50fa7b">src</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;https://code.jquery.com/jquery-2.2.4.min.js&#34;</span>&gt;&lt;/<span style="color:#ff79c6">script</span>&gt;
{% block js %}{% endblock %}
&lt;/<span style="color:#ff79c6">body</span>&gt;
&lt;/<span style="color:#ff79c6">html</span>&gt;
</code></pre></div><p>然后再重新构建我们开发环境的镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose.yml up -d --build
</code></pre></div><p>构建完成后，在浏览器中打开<code>http://127.0.0.1:5001</code>

  <img src="/img/posts/flask-index.png" alt="flask-index">

</p>
<p>怎么来测试呢？如果当前数据库中没有任何数据：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_main_no_users</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;没有用户&#34;&#34;&#34;</span>
    response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/&#39;</span>)
    self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">200</span>)
    self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">&#39;No users!&#39;</span>, response<span style="color:#ff79c6">.</span>data)
</code></pre></div><p>添加几条测试数据，获取所有用户列表，添加一条测试用例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_main_with_users</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;有多个用户的场景&#34;&#34;&#34;</span>
    add_user(<span style="color:#f1fa8c">&#39;cnych&#39;</span>, <span style="color:#f1fa8c">&#39;icnych@gmail.com&#39;</span>)
    add_user(<span style="color:#f1fa8c">&#39;qikqiak&#39;</span>, <span style="color:#f1fa8c">&#39;qikqiak@gmail.com&#39;</span>)
    response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;/&#39;</span>)
    self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">200</span>)
    self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;All Users&#39;</span>, response<span style="color:#ff79c6">.</span>data)
    self<span style="color:#ff79c6">.</span>assertNotIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;No users!&#39;</span>, response<span style="color:#ff79c6">.</span>data)
    self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, response<span style="color:#ff79c6">.</span>data)
    self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;qikqiak&#39;</span>, response<span style="color:#ff79c6">.</span>data)
</code></pre></div><p>现在我们执行测试命令，会测试不通过的，因为还没有将用户列表的数据传递到首页，现在来更改<code>project/api/views.py</code>的<code>index</code>处理函数，增加用户列表的获取：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@users_blueprint.route(<span style="color:#f1fa8c">&#39;/&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">index</span>():
    users <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">.</span>query<span style="color:#ff79c6">.</span>all()
    <span style="color:#ff79c6">return</span> render_template(<span style="color:#f1fa8c">&#39;index.html&#39;</span>, users<span style="color:#ff79c6">=</span>users)
</code></pre></div><p>这样我们就能够将<code>users</code>列表传递到前端页面<code>index.html</code>中去了，然后可以通过标签<code>{% for user in users %}</code>对每一个用户进行渲染了，现在继续执行测试命令，通过~~~</p>
<p>在上面的前端页面中我们可以看到还有一个表单，用户点击提交按钮后可以添加一个新的用户到数据库中，当然继续我们的测试用例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_main_add_user</span>(self):
    <span style="color:#f1fa8c">&#34;&#34;&#34;前端页面添加一个新的用户&#34;&#34;&#34;</span>
    <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>client:
        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>client<span style="color:#ff79c6">.</span>post(
            <span style="color:#f1fa8c">&#39;/&#39;</span>,
            data<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">dict</span>(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cnych@gmail.com&#39;</span>),
            follow_redirects<span style="color:#ff79c6">=</span>True
        )
        self<span style="color:#ff79c6">.</span>assertEqual(response<span style="color:#ff79c6">.</span>status_code, <span style="color:#bd93f9">200</span>)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;All Users&#39;</span>, response<span style="color:#ff79c6">.</span>data)
        self<span style="color:#ff79c6">.</span>assertNotIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;No users!&#39;</span>, response<span style="color:#ff79c6">.</span>data)
        self<span style="color:#ff79c6">.</span>assertIn(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;cnych&#39;</span>, response<span style="color:#ff79c6">.</span>data)
</code></pre></div><p>上面的测试代码中我们看到<code>self.client.post()</code>函数中多了一个<code>follow_redirects=True</code>参数，这样的话能确保<code>post</code>操作完成后页面能够重新刷新，这样的话首页的用户列表数据就能重新获取渲染了，现在继续执行我们的测试命令，会出现一个错误：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">======================================================================</span>
FAIL: test_main_add_user <span style="color:#ff79c6">(</span>test_users.TestUserService<span style="color:#ff79c6">)</span>
前端页面添加一个新的用户
----------------------------------------------------------------------
Traceback <span style="color:#ff79c6">(</span>most recent call last<span style="color:#ff79c6">)</span>:
  File <span style="color:#f1fa8c">&#34;/usr/src/app/project/tests/test_users.py&#34;</span>, line 159, in test_main_add_user
    self.assertEqual<span style="color:#ff79c6">(</span>response.status_code, 200<span style="color:#ff79c6">)</span>
AssertionError: <span style="color:#bd93f9">405</span> !<span style="color:#ff79c6">=</span> <span style="color:#bd93f9">200</span>

----------------------------------------------------------------------
</code></pre></div><p>这是因为在首页的路由处理函数<code>index</code>中还没有对<code>POST</code>的请求进行处理，现在我们继续来更新<code>project/api/views.py</code>的<code>index</code>处理函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">@users_blueprint.route(<span style="color:#f1fa8c">&#39;/&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>, <span style="color:#f1fa8c">&#39;POST&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">index</span>():
    <span style="color:#ff79c6">if</span> request<span style="color:#ff79c6">.</span>method <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;POST&#39;</span>:
        username <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>form[<span style="color:#f1fa8c">&#39;username&#39;</span>]
        email <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>form[<span style="color:#f1fa8c">&#39;email&#39;</span>]
        db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>add(User(username<span style="color:#ff79c6">=</span>username, email<span style="color:#ff79c6">=</span>email))
        db<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>commit()
    users <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">.</span>query<span style="color:#ff79c6">.</span>order_by(User<span style="color:#ff79c6">.</span>created_at<span style="color:#ff79c6">.</span>desc())<span style="color:#ff79c6">.</span>all()
    <span style="color:#ff79c6">return</span> render_template(<span style="color:#f1fa8c">&#39;index.html&#39;</span>, users<span style="color:#ff79c6">=</span>users)
</code></pre></div><p>上面的函数针对<code>POST</code>的请求进行了数据库添加的操作，注意用户列表我们增加了一条根据<code>created_at</code>进行排序的规则还有<code>methods</code>增加了一个<code>POST</code>，现在再来执行我们的测试代码，通过~~~</p>
<p>上面的测试全部通过过后，现在我们将我们的代码部署到生产环境：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -f docker-compose-prod.yml up -d --build
</code></pre></div><p>然后执行测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">(</span>tdd3<span style="color:#ff79c6">)</span>$ docker-compose -run users-service python manage.py <span style="color:#8be9fd;font-style:italic">test</span>
</code></pre></div><p>然后在浏览器中打开<code>http://127.0.0.1</code>(因为生产环境是用<code>Nginx</code>做转发的，所以不用加端口)：

  <img src="/img/posts/WX20180102-110111.png" alt="page-index">

</p>
<p><strong>天下大事，合久必分，分久必合</strong>， 下节课我们就来将项目进行拆分~~~</p>
<p>最后还是广告~~~</p>
<p>扫描下面的二维码(或微信搜索<code>iEverything</code>)添加我微信好友(注明python)，然后可以加入到我们的<code>python</code>讨论群里面共同学习

  <img src="/img/posts/wexin-qrcode.jpeg" alt="qrcode">

</p>

                
                
<div class="entry-shang text-center">
    
	    <p> 「如果这篇文章对你有用,请随意打赏」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://qnxr.xyz"><img src="/img/favicon.png" />青年夏日IT</a></span>
        
	        <p class="tip"><i></i><span>如果这篇文章对你有用,请随意打赏</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/alertmanager-of-prometheus-in-practice/" data-toggle="tooltip" data-placement="top" title="Prometheus报警AlertManager实战">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/upgrading-django-20-10-tips/" data-toggle="tooltip" data-placement="top" title="更新django2.0的10条注意事项">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/affinity" title="affinity">
                            affinity
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/alertmanager" title="alertmanager">
                            alertmanager
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/argo" title="argo">
                            argo
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/cd" title="cd">
                            cd
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/ci" title="ci">
                            ci
                        </a>
                        
                        
                        
                        <a href="/tags/ci/cd" title="ci/cd">
                            ci/cd
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/configmap" title="configmap">
                            configmap
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/coredns" title="coredns">
                            coredns
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/dashboard" title="dashboard">
                            dashboard
                        </a>
                        
                        
                        
                        <a href="/tags/deployment" title="deployment">
                            deployment
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/devops" title="devops">
                            devops
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/django" title="django">
                            django
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/dockerfile" title="dockerfile">
                            dockerfile
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/drone" title="drone">
                            drone
                        </a>
                        
                        
                        
                        <a href="/tags/efk" title="efk">
                            efk
                        </a>
                        
                        
                        
                        <a href="/tags/elastic" title="elastic">
                            elastic
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/envoy" title="envoy">
                            envoy
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/flask" title="flask">
                            flask
                        </a>
                        
                        
                        
                        <a href="/tags/fluentd" title="fluentd">
                            fluentd
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/github" title="github">
                            github
                        </a>
                        
                        
                        
                        <a href="/tags/gitlab" title="gitlab">
                            gitlab
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/gitops" title="gitops">
                            gitops
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/goland" title="goland">
                            goland
                        </a>
                        
                        
                        
                        <a href="/tags/golang" title="golang">
                            golang
                        </a>
                        
                        
                        
                        <a href="/tags/grafana" title="grafana">
                            grafana
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/haproxy" title="haproxy">
                            haproxy
                        </a>
                        
                        
                        
                        <a href="/tags/harbor" title="harbor">
                            harbor
                        </a>
                        
                        
                        
                        <a href="/tags/helm" title="helm">
                            helm
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/https" title="https">
                            https
                        </a>
                        
                        
                        
                        <a href="/tags/hugo" title="hugo">
                            hugo
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/ingress" title="ingress">
                            ingress
                        </a>
                        
                        
                        
                        <a href="/tags/ingress-nginx" title="ingress-nginx">
                            ingress-nginx
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/iptables" title="iptables">
                            iptables
                        </a>
                        
                        
                        
                        <a href="/tags/ipvs" title="ipvs">
                            ipvs
                        </a>
                        
                        
                        
                        <a href="/tags/istio" title="istio">
                            istio
                        </a>
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jenkins" title="jenkins">
                            jenkins
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/k8s" title="k8s">
                            k8s
                        </a>
                        
                        
                        
                        <a href="/tags/k8s%E6%8A%80%E6%9C%AF%E5%9C%88" title="k8s技术圈">
                            k8s技术圈
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/kibana" title="kibana">
                            kibana
                        </a>
                        
                        
                        
                        <a href="/tags/kind" title="kind">
                            kind
                        </a>
                        
                        
                        
                        <a href="/tags/kong" title="kong">
                            kong
                        </a>
                        
                        
                        
                        <a href="/tags/kubeadm" title="kubeadm">
                            kubeadm
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/kubelet" title="kubelet">
                            kubelet
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/kubernetes" title="kubernetes">
                            kubernetes
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/kustomize" title="kustomize">
                            kustomize
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/loki" title="loki">
                            loki
                        </a>
                        
                        
                        
                        <a href="/tags/mac" title="mac">
                            mac
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/microservice" title="microservice">
                            microservice
                        </a>
                        
                        
                        
                        <a href="/tags/monitor" title="monitor">
                            monitor
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/netfilter" title="netfilter">
                            netfilter
                        </a>
                        
                        
                        
                        <a href="/tags/nfs" title="nfs">
                            nfs
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/operator" title="operator">
                            operator
                        </a>
                        
                        
                        
                        <a href="/tags/ops" title="ops">
                            ops
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/pipeline" title="pipeline">
                            pipeline
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/pod" title="pod">
                            pod
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/prometheus" title="prometheus">
                            prometheus
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/pv" title="pv">
                            pv
                        </a>
                        
                        
                        
                        <a href="/tags/pvc" title="pvc">
                            pvc
                        </a>
                        
                        
                        
                        <a href="/tags/pycharm" title="pycharm">
                            pycharm
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/python" title="python">
                            python
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/rbac" title="rbac">
                            rbac
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/scheduler" title="scheduler">
                            scheduler
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/security" title="security">
                            security
                        </a>
                        
                        
                        
                        <a href="/tags/service" title="service">
                            service
                        </a>
                        
                        
                        
                        <a href="/tags/service-api" title="service-api">
                            service-api
                        </a>
                        
                        
                        
                        <a href="/tags/service-mesh" title="service-mesh">
                            service-mesh
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/slave" title="slave">
                            slave
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/storageclass" title="storageclass">
                            storageclass
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/tcpdump" title="tcpdump">
                            tcpdump
                        </a>
                        
                        
                        
                        <a href="/tags/tdd" title="tdd">
                            tdd
                        </a>
                        
                        
                        
                        <a href="/tags/tekton" title="tekton">
                            tekton
                        </a>
                        
                        
                        
                        <a href="/tags/tips" title="tips">
                            tips
                        </a>
                        
                        
                        
                        <a href="/tags/traefik" title="traefik">
                            traefik
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/vault" title="vault">
                            vault
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/vscode" title="vscode">
                            vscode
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/webpack" title="webpack">
                            webpack
                        </a>
                        
                        
                        
                        <a href="/tags/websocket" title="websocket">
                            websocket
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/wsl" title="wsl">
                            wsl
                        </a>
                        
                        
                        
                        <a href="/tags/yaml" title="yaml">
                            yaml
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1" title="微服务">
                            微服务
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E7%9F%A5%E8%AF%86%E6%98%9F%E7%90%83" title="知识星球">
                            知识星球
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E8%AF%BE%E7%A8%8B" title="课程">
                            课程
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%B0%83%E5%BA%A6" title="调度">
                            调度
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91" title="阿里云">
                            阿里云
                        </a>
                        
                        
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    <li>
                        <a href="mailto:1290851757@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

                    
                    <li>
                        <a href="img/wechat_qrcode.jpg">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    

                    
                    <li>
                        <a target="_blank" href="img/wechat_qrcode.jpg">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/xiaobingchan">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    <li>
                        <a target="_blank" href="img/alipay.jpg">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 青年夏日IT 2021
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite"></a><a href="http://qnxr.xyz">青年夏日IT版权所有</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=xiaobingchan&repo=xiaobingchan.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-150373352-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>
